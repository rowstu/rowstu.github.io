<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>HashiCorp Packer – Comprehensive Notes & Procedures // rowstu.net</title><link rel=stylesheet href=/assets/shared-theme.css><style>.markdown-content{max-width:900px;margin:0 auto;line-height:1.7}.markdown-content h1{font-size:2.5rem;margin-bottom:1rem;color:var(--accent-teal);border-bottom:2px solid var(--border);padding-bottom:.5rem}.markdown-content h2{font-size:2rem;margin-top:2rem;margin-bottom:1rem;color:var(--accent-orange)}.markdown-content h3{font-size:1.5rem;margin-top:1.5rem;margin-bottom:.75rem;color:var(--text-primary)}.markdown-content p{margin-bottom:1rem}.markdown-content code{background:var(--bg-light);padding:.2rem .4rem;border-radius:3px;font-family:jetbrains mono,monospace;font-size:.9em}.markdown-content pre{background:var(--bg-light);padding:1rem;border-radius:6px;overflow-x:auto;margin-bottom:1rem}.markdown-content pre code{background:0 0;padding:0}.markdown-content a{color:var(--accent-teal);text-decoration:none}.markdown-content a:hover{text-decoration:underline}.markdown-content ul,.markdown-content ol{margin-bottom:1rem;padding-left:2rem}.markdown-content li{margin-bottom:.5rem}.markdown-content blockquote{border-left:4px solid var(--accent-teal);padding-left:1rem;margin:1rem 0;color:var(--text-secondary);font-style:italic}.markdown-content table{width:100%;border-collapse:collapse;margin-bottom:1rem}.markdown-content th,.markdown-content td{border:1px solid var(--border);padding:.75rem;text-align:left}.markdown-content th{background:var(--bg-light);font-weight:600}.breadcrumb{padding:1rem 0;color:var(--text-secondary);font-size:.95rem}.breadcrumb a{color:var(--accent-teal);text-decoration:none}.breadcrumb a:hover{text-decoration:underline}</style></head><body><div class=app-header><h1 class=app-title>HashiCorp Packer – Comprehensive Notes & Procedures</h1></div><div class=container><div class=breadcrumb><a href=/>Home</a> / <a href=/browse/>Browse</a>/ <a href=/packernotes/>Packernotes</a></div><div class="card markdown-content"><p><strong>HashiCorp Packer</strong> is a tool for <strong>automating the creation of machine images</strong> from a single source configuration.</p><p>A <em>machine image</em> can be:</p><ul><li>AWS AMI</li><li>Azure Managed Image</li><li>GCP Image</li><li>VMware / VirtualBox image</li><li>Docker image</li><li>Raw disk image (qcow2, vmdk, etc.)</li></ul><p>Packer is <strong>image-focused</strong>, not infrastructure-focused.</p><blockquote><p>If Terraform creates <em>infrastructure</em>, Packer creates the <em>golden images</em> that infrastructure boots from.</p></blockquote><hr><h3 id=primary-use-cases>Primary Use Cases</h3><p>Packer is typically used to:</p><ul><li>Build <strong>golden OS images</strong></li><li>Pre-install packages, agents, and configuration</li><li>Reduce boot-time configuration (faster scaling)</li><li>Enforce consistency across environments</li><li>Create immutable infrastructure</li></ul><p>Common examples:</p><ul><li>Hardened Linux AMIs</li><li>CI runner images</li><li>Kubernetes node images</li><li>Base images for auto-scaling groups</li></ul><hr><h3 id=why-use-packer>Why Use Packer?</h3><p><strong>Before Packer</strong></p><ul><li>cloud-init scripts</li><li>large Ansible playbooks on first boot</li><li>slow, inconsistent node startup</li></ul><p><strong>With Packer</strong></p><ul><li>bake dependencies once</li><li>deploy identical images everywhere</li><li>faster scaling</li><li>fewer runtime failures</li></ul><p><strong>Key benefits</strong></p><ul><li>Repeatable builds</li><li>Multi-cloud from one template</li><li>Works with existing tools (Ansible, Shell, Chef)</li><li>Strong CI/CD fit</li></ul><hr><h2 id=2-installation-and-setup>2. Installation and Setup</h2><h3 id=installing-packer>Installing Packer</h3><h4 id=linux-recommended-method>Linux (Recommended method)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo dnf install -y dnf-plugins-core
</span></span><span style=display:flex><span>sudo dnf config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
</span></span><span style=display:flex><span>sudo dnf install -y packer
</span></span></code></pre></div><p>Debian/Ubuntu:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp.gpg
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;deb [signed-by=/usr/share/keyrings/hashicorp.gpg] https://apt.releases.hashicorp.com </span><span style=color:#66d9ef>$(</span>lsb_release -cs<span style=color:#66d9ef>)</span><span style=color:#e6db74> main&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>| sudo tee /etc/apt/sources.list.d/hashicorp.list
</span></span><span style=display:flex><span>sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt install packer
</span></span></code></pre></div><p>Verify:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>packer version
</span></span></code></pre></div><hr><h3 id=authentication-setup-cloud-providers>Authentication Setup (Cloud Providers)</h3><p>Packer <strong>does not manage credentials</strong> — it relies on native SDKs.</p><h4 id=aws>AWS</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export AWS_ACCESS_KEY_ID<span style=color:#f92672>=</span>...
</span></span><span style=display:flex><span>export AWS_SECRET_ACCESS_KEY<span style=color:#f92672>=</span>...
</span></span><span style=display:flex><span>export AWS_DEFAULT_REGION<span style=color:#f92672>=</span>eu-west-1
</span></span></code></pre></div><p>Or use:</p><ul><li>IAM instance profiles</li><li>AWS CLI profiles</li></ul><h4 id=azure>Azure</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az login
</span></span></code></pre></div><p>Or service principal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export ARM_CLIENT_ID<span style=color:#f92672>=</span>...
</span></span><span style=display:flex><span>export ARM_CLIENT_SECRET<span style=color:#f92672>=</span>...
</span></span><span style=display:flex><span>export ARM_SUBSCRIPTION_ID<span style=color:#f92672>=</span>...
</span></span><span style=display:flex><span>export ARM_TENANT_ID<span style=color:#f92672>=</span>...
</span></span></code></pre></div><h4 id=gcp>GCP</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud auth application-default login
</span></span></code></pre></div><hr><h2 id=3-building-images-with-packer>3. Building Images with Packer</h2><h3 id=packer-template-formats>Packer Template Formats</h3><p>Packer supports:</p><ul><li>❌ JSON (legacy)</li><li>✅ <strong>HCL2 (recommended)</strong></li></ul><p>Always use <strong>HCL</strong> unless maintaining old builds.</p><hr><h2 id=core-concepts>Core Concepts</h2><h3 id=builders>Builders</h3><p>Define <strong>what image to build and where</strong>.</p><p>Examples:</p><ul><li><code>amazon-ebs</code></li><li><code>azure-arm</code></li><li><code>googlecompute</code></li><li><code>docker</code></li><li><code>qemu</code></li></ul><hr><h3 id=provisioners>Provisioners</h3><p>Define <strong>how the image is configured</strong>.</p><p>Examples:</p><ul><li><code>shell</code></li><li><code>ansible</code></li><li><code>file</code></li><li><code>powershell</code></li></ul><hr><h3 id=post-processors>Post-Processors</h3><p>Act <strong>after image creation</strong>.</p><p>Examples:</p><ul><li>compress</li><li>upload artifact</li><li>generate manifest</li></ul><hr><h2 id=example-aws-ami-hcl>Example: AWS AMI (HCL)</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>packer</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>required_plugins</span> {
</span></span><span style=display:flex><span>    amazon <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github.com/hashicorp/amazon&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;~&gt; 1.3&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;region&#34;</span> {
</span></span><span style=display:flex><span>  default <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;eu-west-1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>source</span> <span style=color:#e6db74>&#34;amazon-ebs&#34; &#34;ubuntu&#34;</span> {
</span></span><span style=display:flex><span>  region        <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>region</span>
</span></span><span style=display:flex><span>  instance_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;t3.micro&#34;</span>
</span></span><span style=display:flex><span>  ami_name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ubuntu-22.04-base-{{timestamp}}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>source_ami_filter</span> {
</span></span><span style=display:flex><span>    filters <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ubuntu/images/*ubuntu-jammy-22.04-amd64-server-*&#34;</span>
</span></span><span style=display:flex><span>      virtualization-type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hvm&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    owners      <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;099720109477&#34;</span>]
</span></span><span style=display:flex><span>    most_recent <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ssh_username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ubuntu&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>build</span> {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ubuntu-base&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  sources <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;source.amazon-ebs.ubuntu&#34;</span>
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>provisioner</span> <span style=color:#e6db74>&#34;shell&#34;</span> {
</span></span><span style=display:flex><span>    inline <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;sudo apt update&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;sudo apt install -y nginx curl&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;sudo systemctl enable nginx&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Run it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>packer init .
</span></span><span style=display:flex><span>packer validate .
</span></span><span style=display:flex><span>packer build .
</span></span></code></pre></div><hr><h2 id=using-ansible-as-a-provisioner>Using Ansible as a Provisioner</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>provisioner</span> <span style=color:#e6db74>&#34;ansible&#34;</span> {
</span></span><span style=display:flex><span>  playbook_file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;playbooks/base.yml&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This fits <strong>perfectly</strong> if your team already uses Ansible (which you do).</p><hr><h2 id=4-best-practices>4. Best Practices</h2><h3 id=image-design>Image Design</h3><ul><li><strong>One purpose per image</strong></li><li>Avoid “everything images”</li><li>Keep images small and focused</li></ul><hr><h3 id=version-control>Version Control</h3><ul><li>Store templates in Git</li><li>Tag images with Git SHA</li><li>Use semantic versioning in AMI names</li></ul><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>ami_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;webserver-{{git_commit}}&#34;</span>
</span></span></code></pre></div><hr><h3 id=modularization>Modularization</h3><p>Use <strong>multiple files</strong>:</p><pre tabindex=0><code>packer/
├── variables.pkr.hcl
├── aws.pkr.hcl
├── build.pkr.hcl
</code></pre><p>Variables file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;environment&#34;</span> {
</span></span><span style=display:flex><span>  type <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h3 id=security>Security</h3><ul><li>Never bake secrets into images</li><li>Use runtime secrets (Vault, AWS SSM)</li><li>Disable SSH passwords</li><li>Remove temporary users</li></ul><hr><h3 id=testing-images>Testing Images</h3><ul><li>Boot image after build</li><li>Validate services</li><li>Run InSpec or Serverspec</li><li>Smoke-test in CI</li></ul><hr><h2 id=5-common-use-cases>5. Common Use Cases</h2><h3 id=cicd-pipelines>CI/CD Pipelines</h3><p>Typical flow:</p><ol><li>Packer builds image</li><li>Image ID passed to Terraform</li><li>Terraform deploys infra</li><li>Old images retired</li></ol><p>This creates <strong>immutable deployments</strong>.</p><hr><h3 id=auto-scaling-groups>Auto Scaling Groups</h3><ul><li>Pre-installed agents</li><li>Faster scale-out</li><li>Predictable nodes</li></ul><hr><h3 id=kubernetes-nodes>Kubernetes Nodes</h3><ul><li>Container runtime baked in</li><li>Kubelet pre-configured</li><li>No slow bootstrap</li></ul><hr><h3 id=compliance--hardening>Compliance / Hardening</h3><ul><li>CIS benchmarks</li><li>OS-level hardening</li><li>Audit-ready images</li></ul><hr><h2 id=6-debugging-and-troubleshooting>6. Debugging and Troubleshooting</h2><h3 id=run-in-debug-mode>Run in Debug Mode</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PACKER_LOG<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> packer build .
</span></span></code></pre></div><p>Verbose logging:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PACKER_LOG<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> PACKER_LOG_PATH<span style=color:#f92672>=</span>packer.log packer build .
</span></span></code></pre></div><hr><h3 id=pause-on-failure>Pause on Failure</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>packer build -on-error<span style=color:#f92672>=</span>ask .
</span></span></code></pre></div><p>This lets you SSH into the failed instance.</p><hr><h3 id=common-issues>Common Issues</h3><table><thead><tr><th>Problem</th><th>Cause</th><th>Fix</th></tr></thead><tbody><tr><td>SSH timeout</td><td>Wrong username</td><td>Check base AMI</td></tr><tr><td>Provisioner fails</td><td>Missing sudo</td><td>Ensure user has sudo</td></tr><tr><td>API errors</td><td>IAM permissions</td><td>Check policies</td></tr><tr><td>Slow builds</td><td>Too many provisioners</td><td>Bake more, configure less</td></tr></tbody></table><hr><h3 id=validate-early>Validate Early</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>packer validate .
</span></span></code></pre></div><p>Always validate before building.</p><hr><h2 id=7-resources-for-further-learning>7. Resources for Further Learning</h2><h3 id=official-documentation>Official Documentation</h3><ul><li>HashiCorp Packer Docs</li><li>Packer Plugin Registry</li></ul><h3 id=books>Books</h3><ul><li><em>Infrastructure as Code</em> – Kief Morris</li><li><em>Terraform: Up & Running</em> (Packer concepts apply)</li></ul><h3 id=courses>Courses</h3><ul><li>HashiCorp Learn (free)</li><li>Udemy: “Packer Deep Dive”</li><li>Pluralsight: Immutable Infrastructure</li></ul><h3 id=practical-learning>Practical Learning</h3><ul><li><p>Build AMIs for:</p><ul><li>CI runners</li><li>Web servers</li><li>Kubernetes nodes</li></ul></li><li><p>Integrate with Terraform</p></li><li><p>Add image tests</p></li></ul><hr><h2 id=final-advice-straight-talk>Final Advice (Straight Talk)</h2><p>If you’re already:</p><ul><li>Using Ansible</li><li>Running cloud infra</li><li>Caring about reliability</li></ul><p>Then <strong>Packer is not optional anymore</strong> — it’s the foundation for clean, fast, repeatable infrastructure.</p><p>If you want next steps, I can:</p><ul><li>Design a <strong>Packer + Ansible + Terraform workflow</strong></li><li>Convert an existing Ansible role into a Packer build</li><li>Create <strong>interview-grade explanations</strong> of Packer internals</li></ul><p>Just tell me where you want to go next.</p></div></div><script src=/assets/shared-nav.js></script></body></html>