<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Namespaces // rowstu.net</title><link rel=stylesheet href=/assets/shared-theme.css><style>.markdown-content{max-width:900px;margin:0 auto;line-height:1.7}.markdown-content h1{font-size:2.5rem;margin-bottom:1rem;color:var(--accent-teal);border-bottom:2px solid var(--border);padding-bottom:.5rem}.markdown-content h2{font-size:2rem;margin-top:2rem;margin-bottom:1rem;color:var(--accent-orange)}.markdown-content h3{font-size:1.5rem;margin-top:1.5rem;margin-bottom:.75rem;color:var(--text-primary)}.markdown-content p{margin-bottom:1rem}.markdown-content code{background:var(--bg-light);padding:.2rem .4rem;border-radius:3px;font-family:jetbrains mono,monospace;font-size:.9em}.markdown-content pre{background:var(--bg-light);padding:1rem;border-radius:6px;overflow-x:auto;margin-bottom:1rem}.markdown-content pre code{background:0 0;padding:0}.markdown-content a{color:var(--accent-teal);text-decoration:none}.markdown-content a:hover{text-decoration:underline}.markdown-content ul,.markdown-content ol{margin-bottom:1rem;padding-left:2rem}.markdown-content li{margin-bottom:.5rem}.markdown-content blockquote{border-left:4px solid var(--accent-teal);padding-left:1rem;margin:1rem 0;color:var(--text-secondary);font-style:italic}.markdown-content table{width:100%;border-collapse:collapse;margin-bottom:1rem}.markdown-content th,.markdown-content td{border:1px solid var(--border);padding:.75rem;text-align:left}.markdown-content th{background:var(--bg-light);font-weight:600}.breadcrumb{padding:1rem 0;color:var(--text-secondary);font-size:.95rem}.breadcrumb a{color:var(--accent-teal);text-decoration:none}.breadcrumb a:hover{text-decoration:underline}</style></head><body><div class=app-header><h1 class=app-title>Namespaces</h1></div><div class=container><div class=breadcrumb><a href=/>Home</a> / <a href=/browse/>Browse</a>/ <a href=/linuxnamespaces/>Linuxnamespaces</a></div><div class="card markdown-content"><h1 id=isolating-nginx-in-a-linux-namespace-with-cpu-memory-limits-and-custom-networking>Isolating NGINX in a Linux Namespace with CPU, Memory Limits, and Custom Networking</h1><p>Based on: <a href=https://blog.nginx.org/blog/what-are-namespaces-cgroups-how-do-they-work>https://blog.nginx.org/blog/what-are-namespaces-cgroups-how-do-they-work</a></p><h3 id=1-create-a-directory-for-the-static-hello-world-page>1. Create a Directory for the Static &ldquo;Hello World&rdquo; Page</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/hello-world
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello World&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span> &gt; /tmp/hello-world/index.html
</span></span></code></pre></div><h3 id=2-set-up-cpu-and-memory-limits-using-cgroups>2. Set Up CPU and Memory Limits using Cgroups</h3><h4 id=21-create-and-configure-the-cpu-cgroup>2.1 Create and Configure the CPU Cgroup</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Create a cgroup for limiting CPU usage (20%)</span>
</span></span><span style=display:flex><span>sudo mkdir /sys/fs/cgroup/cpu/hello-world-cgroup
</span></span><span style=display:flex><span>echo <span style=color:#ae81ff>20000</span> | sudo tee /sys/fs/cgroup/cpu/hello-world-cgroup/cpu.cfs_quota_us
</span></span><span style=display:flex><span>echo <span style=color:#ae81ff>100000</span> | sudo tee /sys/fs/cgroup/cpu/hello-world-cgroup/cpu.cfs_period_us
</span></span></code></pre></div><h4 id=22-create-and-configure-the-memory-cgroup>2.2 Create and Configure the Memory Cgroup</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Create a cgroup for limiting memory usage (1GB)</span>
</span></span><span style=display:flex><span>sudo mkdir /sys/fs/cgroup/memory/hello-world-cgroup
</span></span><span style=display:flex><span>echo <span style=color:#66d9ef>$((</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span><span style=color:#66d9ef>))</span> | sudo tee /sys/fs/cgroup/memory/hello-world-cgroup/memory.limit_in_bytes
</span></span></code></pre></div><h3 id=3-create-a-network-namespace-and-run-nginx-inside-it>3. Create a Network Namespace and Run NGINX Inside It</h3><h4 id=31-create-a-new-network-namespace>3.1 Create a New Network Namespace</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Create a new network namespace and run NGINX</span>
</span></span><span style=display:flex><span>sudo unshare --net --fork --mount-proc /bin/bash
</span></span></code></pre></div><p>This command will open a new shell inside a new network namespace.</p><h3 id=4-install-and-configure-nginx>4. Install and Configure NGINX</h3><h4 id=41-install-nginx-inside-the-namespace>4.1 Install NGINX inside the namespace</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Update package list and install NGINX</span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install -y nginx
</span></span></code></pre></div><h4 id=42-configure-nginx-to-serve-the-static-page>4.2 Configure NGINX to Serve the Static Page</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Edit NGINX config to point to /tmp/hello-world</span>
</span></span><span style=display:flex><span>sudo nano /etc/nginx/sites-available/default
</span></span></code></pre></div><p>Replace the content of the <code>server</code> block with the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/tmp/hello-world</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>_</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=43-start-the-nginx-service>4.3 Start the NGINX Service</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Start the NGINX service</span>
</span></span><span style=display:flex><span>sudo systemctl start nginx
</span></span></code></pre></div><h3 id=5-set-up-networking>5. Set Up Networking</h3><h4 id=51-create-a-virtual-ethernet-pair>5.1 Create a Virtual Ethernet Pair</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Create a virtual Ethernet pair (veth)</span>
</span></span><span style=display:flex><span>sudo ip link add veth0 type veth peer name veth1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Bring up the veth interfaces on the host and inside the namespace</span>
</span></span><span style=display:flex><span>sudo ip link set veth0 up
</span></span><span style=display:flex><span>sudo ip link set veth1 up
</span></span></code></pre></div><h4 id=52-move-veth1-into-the-network-namespace>5.2 Move <code>veth1</code> into the Network Namespace</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Move veth1 into the network namespace</span>
</span></span><span style=display:flex><span>sudo ip link set veth1 netns &lt;nginx_pid&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Access the network namespace</span>
</span></span><span style=display:flex><span>sudo ip netns exec &lt;nginx_pid&gt; /bin/bash
</span></span></code></pre></div><h4 id=53-configure-networking-in-the-namespace>5.3 Configure Networking in the Namespace</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ip addr add 192.168.100.10/24 dev veth1
</span></span><span style=display:flex><span>sudo ip link set veth1 up
</span></span><span style=display:flex><span>sudo ip addr add 192.168.100.1/24 dev veth0
</span></span><span style=display:flex><span>sudo ip link set veth0 up
</span></span><span style=display:flex><span>sudo sysctl -w net.ipv4.ip_forward<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span></span><span style=display:flex><span>sudo ip route add default via 192.168.100.1
</span></span></code></pre></div><h3 id=6-start-nginx-to-listen-on-the-custom-ip-address>6. Start NGINX to Listen on the Custom IP Address</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># /etc/nginx/sites-available/default</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    listen 192.168.100.10:80;
</span></span><span style=display:flex><span>    root /tmp/hello-world;
</span></span><span style=display:flex><span>    index index.html;
</span></span><span style=display:flex><span>    server_name _;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        try_files $uri $uri/ <span style=color:#f92672>=</span>404;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl restart nginx
</span></span></code></pre></div><h3 id=7-access-the-nginx-web-page>7. Access the NGINX Web Page</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://192.168.100.10
</span></span></code></pre></div><h3 id=8-clean-up>8. Clean Up</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Delete the virtual Ethernet pair</span>
</span></span><span style=display:flex><span>sudo ip link delete veth0
</span></span><span style=display:flex><span>sudo ip link delete veth1
</span></span><span style=display:flex><span>sudo sysctl -w net.ipv4.ip_forward<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>sudo iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
</span></span></code></pre></div></div></div><script src=/assets/shared-nav.js></script></body></html>