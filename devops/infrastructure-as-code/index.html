<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Infrastructure as Code // rowstu.net</title><link rel=stylesheet href=/assets/shared-theme.css><style>.markdown-content{max-width:900px;margin:0 auto;line-height:1.7}.markdown-content h1{font-size:2.5rem;margin-bottom:1rem;color:var(--accent-teal);border-bottom:2px solid var(--border);padding-bottom:.5rem}.markdown-content h2{font-size:2rem;margin-top:2rem;margin-bottom:1rem;color:var(--accent-orange)}.markdown-content h3{font-size:1.5rem;margin-top:1.5rem;margin-bottom:.75rem;color:var(--text-primary)}.markdown-content p{margin-bottom:1rem}.markdown-content code{background:var(--bg-light);padding:.2rem .4rem;border-radius:3px;font-family:jetbrains mono,monospace;font-size:.9em}.markdown-content pre{background:var(--bg-light);padding:1rem;border-radius:6px;overflow-x:auto;margin-bottom:1rem}.markdown-content pre code{background:0 0;padding:0}.markdown-content a{color:var(--accent-teal);text-decoration:none}.markdown-content a:hover{text-decoration:underline}.markdown-content ul,.markdown-content ol{margin-bottom:1rem;padding-left:2rem}.markdown-content li{margin-bottom:.5rem}.markdown-content blockquote{border-left:4px solid var(--accent-teal);padding-left:1rem;margin:1rem 0;color:var(--text-secondary);font-style:italic}.markdown-content table{width:100%;border-collapse:collapse;margin-bottom:1rem}.markdown-content th,.markdown-content td{border:1px solid var(--border);padding:.75rem;text-align:left}.markdown-content th{background:var(--bg-light);font-weight:600}.breadcrumb{padding:1rem 0;color:var(--text-secondary);font-size:.95rem}.breadcrumb a{color:var(--accent-teal);text-decoration:none}.breadcrumb a:hover{text-decoration:underline}</style></head><body><div class=app-header><h1 class=app-title>Infrastructure as Code</h1></div><div class=container><div class=breadcrumb><a href=/>Home</a> / <a href=/browse/>Browse</a>/ <a href=/devopsinfrastructure-as-code/>Devopsinfrastructure as Code</a></div><div class="card markdown-content"><h1 id=infrastructure-as-code-best-practices>Infrastructure as Code Best Practices</h1><p>Managing infrastructure through code for consistency, repeatability, and automation.</p><hr><h2 id=core-principles>Core Principles</h2><h3 id=declarative-over-imperative>Declarative over Imperative</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Declarative (preferred) - describe desired state
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_instance&#34; &#34;web&#34;</span> {
</span></span><span style=display:flex><span>  ami           <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ami-12345678&#34;</span>
</span></span><span style=display:flex><span>  instance_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;t3.micro&#34;</span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;web-server&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Imperative - describe steps to achieve state</span>
</span></span><span style=display:flex><span>aws ec2 run-instances --image-id ami-12345678 --instance-type t3.micro
</span></span><span style=display:flex><span>aws ec2 create-tags --resources i-xxx --tags Key<span style=color:#f92672>=</span>Name,Value<span style=color:#f92672>=</span>web-server
</span></span></code></pre></div><ul><li>Declarative: what you want</li><li>Imperative: how to get there</li><li>Declarative is idempotent</li><li>Easier to understand and maintain</li></ul><h3 id=idempotency>Idempotency</h3><p>Running the same code multiple times produces the same result.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Run once: creates resource
</span></span></span><span style=display:flex><span><span style=color:#75715e># Run again: no changes (already exists)
</span></span></span><span style=display:flex><span><span style=color:#75715e># Run after drift: corrects drift
</span></span></span></code></pre></div><h3 id=immutable-infrastructure>Immutable Infrastructure</h3><pre tabindex=0><code>Mutable (bad):
┌─────────┐     ┌─────────┐
│ Server  │ ──▶ │ Server  │  (patched in place)
│  v1.0   │     │  v1.1   │
└─────────┘     └─────────┘

Immutable (good):
┌─────────┐     ┌─────────┐
│ Server  │     │ Server  │  (replaced entirely)
│  v1.0   │     │  v1.1   │
└─────────┘     └─────────┘
    ↓               ↑
 destroy         create
</code></pre><ul><li>Never modify running infrastructure</li><li>Replace rather than update</li><li>Consistent, predictable deployments</li><li>Easy rollback</li></ul><hr><h2 id=version-control>Version Control</h2><h3 id=everything-in-git>Everything in Git</h3><pre tabindex=0><code>infrastructure/
├── terraform/
│   ├── modules/
│   │   ├── vpc/
│   │   ├── eks/
│   │   └── rds/
│   ├── environments/
│   │   ├── dev/
│   │   ├── staging/
│   │   └── prod/
│   └── main.tf
├── ansible/
│   ├── playbooks/
│   └── roles/
└── kubernetes/
    ├── base/
    └── overlays/
</code></pre><h3 id=meaningful-commits>Meaningful Commits</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Good</span>
</span></span><span style=display:flex><span>git commit -m <span style=color:#e6db74>&#34;Add RDS instance for user database
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- PostgreSQL 15.2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- db.t3.medium in prod, db.t3.micro in dev
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- Multi-AZ enabled in prod
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- Automated backups with 7-day retention&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Bad</span>
</span></span><span style=display:flex><span>git commit -m <span style=color:#e6db74>&#34;updated terraform&#34;</span>
</span></span></code></pre></div><h3 id=branch-strategy>Branch Strategy</h3><pre tabindex=0><code>main (protected)
├── feature/add-redis-cluster
├── feature/update-vpc-cidr
└── hotfix/fix-security-group

Pull Request → Review → Merge → Apply
</code></pre><hr><h2 id=modularity>Modularity</h2><h3 id=reusable-modules>Reusable Modules</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># modules/vpc/main.tf
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;cidr_block&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;environment&#34;</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_vpc&#34; &#34;main&#34;</span> {
</span></span><span style=display:flex><span>  cidr_block <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>cidr_block</span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Environment <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>environment</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;vpc_id&#34;</span> {
</span></span><span style=display:flex><span>  value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># environments/prod/main.tf
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;vpc&#34;</span> {
</span></span><span style=display:flex><span>  source      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;../../modules/vpc&#34;</span>
</span></span><span style=display:flex><span>  cidr_block  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.0.0.0/16&#34;</span>
</span></span><span style=display:flex><span>  environment <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;prod&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=module-best-practices>Module Best Practices</h3><ul><li>Single responsibility</li><li>Clear inputs and outputs</li><li>Sensible defaults</li><li>Documentation</li><li>Versioned releases</li></ul><h3 id=dry-dont-repeat-yourself>DRY (Don&rsquo;t Repeat Yourself)</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Bad: duplicated code
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_security_group&#34; &#34;web_dev&#34;</span> { ... }
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_security_group&#34; &#34;web_staging&#34;</span> { ... }
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_security_group&#34; &#34;web_prod&#34;</span> { ... }<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Good: reusable module
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;web_sg&#34;</span> {
</span></span><span style=display:flex><span>  for_each    <span style=color:#f92672>=</span> <span style=color:#66d9ef>toset</span>([<span style=color:#e6db74>&#34;dev&#34;, &#34;staging&#34;, &#34;prod&#34;</span>])
</span></span><span style=display:flex><span>  source      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./modules/security-group&#34;</span>
</span></span><span style=display:flex><span>  environment <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>key</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=state-management>State Management</h2><h3 id=remote-state>Remote State</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># backend.tf
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>backend</span> <span style=color:#e6db74>&#34;s3&#34;</span> {
</span></span><span style=display:flex><span>    bucket         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;company-terraform-state&#34;</span>
</span></span><span style=display:flex><span>    key            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;prod/terraform.tfstate&#34;</span>
</span></span><span style=display:flex><span>    region         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;eu-west-1&#34;</span>
</span></span><span style=display:flex><span>    encrypt        <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    dynamodb_table <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-locks&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=state-best-practices>State Best Practices</h3><table><thead><tr><th>Practice</th><th>Description</th></tr></thead><tbody><tr><td>Remote state</td><td>Never local state in production</td></tr><tr><td>State locking</td><td>Prevent concurrent modifications</td></tr><tr><td>Encryption</td><td>Encrypt state at rest</td></tr><tr><td>Backup</td><td>Regular state backups</td></tr><tr><td>Isolation</td><td>Separate state per environment</td></tr></tbody></table><h3 id=state-isolation>State Isolation</h3><pre tabindex=0><code>terraform-state/
├── network/terraform.tfstate
├── compute/terraform.tfstate
├── database/terraform.tfstate
└── monitoring/terraform.tfstate
</code></pre><ul><li>Limit blast radius</li><li>Faster operations</li><li>Independent changes</li><li>Clear ownership</li></ul><hr><h2 id=environment-management>Environment Management</h2><h3 id=environment-parity>Environment Parity</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># environments/dev/terraform.tfvars
</span></span></span><span style=display:flex><span>instance_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;t3.micro&#34;</span>
</span></span><span style=display:flex><span>replica_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>multi_az      <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># environments/prod/terraform.tfvars
</span></span></span><span style=display:flex><span>instance_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;t3.large&#34;</span>
</span></span><span style=display:flex><span>replica_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>multi_az      <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Same code, different configuration.</p><h3 id=workspace-vs-directories>Workspace vs Directories</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Workspaces (simple)</span>
</span></span><span style=display:flex><span>terraform workspace new dev
</span></span><span style=display:flex><span>terraform workspace new prod
</span></span><span style=display:flex><span>terraform workspace <span style=color:#66d9ef>select</span> prod
</span></span><span style=display:flex><span>terraform apply
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Directories (recommended for isolation)</span>
</span></span><span style=display:flex><span>cd environments/prod
</span></span><span style=display:flex><span>terraform apply
</span></span></code></pre></div><h3 id=configuration-hierarchy>Configuration Hierarchy</h3><pre tabindex=0><code>Base Config → Environment Config → Secrets
     ↓              ↓                 ↓
 defaults      overrides         runtime
</code></pre><hr><h2 id=security>Security</h2><h3 id=secrets-management>Secrets Management</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Bad: secrets in code
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_db_instance&#34; &#34;main&#34;</span> {
</span></span><span style=display:flex><span>  password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;supersecret123&#34;</span><span style=color:#75715e>  # Never do this!
</span></span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Good: external secrets
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_db_instance&#34; &#34;main&#34;</span> {
</span></span><span style=display:flex><span>  password <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>aws_secretsmanager_secret_version</span>.<span style=color:#66d9ef>db</span>.<span style=color:#66d9ef>secret_string</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Or use variables with sensitive flag
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;db_password&#34;</span> {
</span></span><span style=display:flex><span>  type      <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  sensitive <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=least-privilege>Least Privilege</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># IaC service account permissions
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_policy&#34; &#34;terraform&#34;</span> {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-policy&#34;</span>
</span></span><span style=display:flex><span>  policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>({
</span></span><span style=display:flex><span>    Version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2012-10-17&#34;</span>
</span></span><span style=display:flex><span>    Statement <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        Effect <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>        Action <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;ec2:*&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;rds:*&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;s3:*&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        Resource <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>        Condition <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          StringEquals <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;aws:RequestedRegion&#34;: &#34;eu-west-1&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=security-scanning>Security Scanning</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Pre-commit hooks</span>
</span></span><span style=display:flex><span><span style=color:#f92672>repos</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>repo</span>: <span style=color:#ae81ff>https://github.com/antonbabenko/pre-commit-terraform</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hooks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>terraform_tfsec</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>terraform_checkov</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>terraform_validate</span>
</span></span></code></pre></div><p>Tools:</p><ul><li><strong>tfsec</strong>: Security scanner for Terraform</li><li><strong>checkov</strong>: Policy-as-code for IaC</li><li><strong>terrascan</strong>: Static code analyser</li><li><strong>OPA/Conftest</strong>: Policy enforcement</li></ul><hr><h2 id=testing>Testing</h2><h3 id=testing-pyramid-for-iac>Testing Pyramid for IaC</h3><pre tabindex=0><code>                    /\
                   /  \
                  / E2E\        Integration tests
                 /──────\
                /        \
               / Contract  \   Policy/compliance
              /──────────────\
             /                \
            /      Static      \  Linting, validation
           /────────────────────\
</code></pre><h3 id=static-analysis>Static Analysis</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Terraform</span>
</span></span><span style=display:flex><span>terraform fmt -check
</span></span><span style=display:flex><span>terraform validate
</span></span><span style=display:flex><span>tflint
</span></span><span style=display:flex><span>tfsec
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Ansible</span>
</span></span><span style=display:flex><span>ansible-lint
</span></span><span style=display:flex><span>yamllint
</span></span></code></pre></div><h3 id=policy-testing>Policy Testing</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rego data-lang=rego><span style=display:flex><span><span style=color:#75715e># policy/security.rego</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>package</span> <span style=color:#a6e22e>terraform</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>deny[<span style=color:#a6e22e>msg</span>] {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>input</span><span style=color:#f92672>.</span><span style=color:#a6e22e>resource_changes</span>[<span style=color:#a6e22e>_</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource</span><span style=color:#f92672>.</span><span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;aws_s3_bucket&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>not</span> <span style=color:#a6e22e>resource</span><span style=color:#f92672>.</span><span style=color:#a6e22e>change</span><span style=color:#f92672>.</span><span style=color:#a6e22e>after</span><span style=color:#f92672>.</span><span style=color:#a6e22e>server_side_encryption_configuration</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sprintf</span>(<span style=color:#e6db74>&#34;S3 bucket %s must have encryption enabled&#34;</span><span style=color:#f92672>,</span> [<span style=color:#a6e22e>resource</span><span style=color:#f92672>.</span><span style=color:#a6e22e>address</span>])
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=integration-testing>Integration Testing</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Terratest example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestVpcModule</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>terraformOptions</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>terraform</span>.<span style=color:#a6e22e>Options</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TerraformDir</span>: <span style=color:#e6db74>&#34;../modules/vpc&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Vars</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;cidr_block&#34;</span>: <span style=color:#e6db74>&#34;10.0.0.0/16&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>terraform</span>.<span style=color:#a6e22e>Destroy</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>terraformOptions</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>terraform</span>.<span style=color:#a6e22e>InitAndApply</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>terraformOptions</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vpcId</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>terraform</span>.<span style=color:#a6e22e>Output</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>terraformOptions</span>, <span style=color:#e6db74>&#34;vpc_id&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>NotEmpty</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>vpcId</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=documentation>Documentation</h2><h3 id=self-documenting-code>Self-Documenting Code</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;instance_type&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;EC2 instance type for the web servers&#34;</span>
</span></span><span style=display:flex><span>  default     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;t3.micro&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>validation</span> {
</span></span><span style=display:flex><span>    condition     <span style=color:#f92672>=</span> <span style=color:#66d9ef>can</span>(<span style=color:#66d9ef>regex</span>(<span style=color:#e6db74>&#34;^t3\\.&#34;</span>, <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>instance_type</span>))
</span></span><span style=display:flex><span>    error_message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Instance type must be from the t3 family.&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=readme-template>README Template</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown><span style=display:flex><span># Module Name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Description
</span></span></span><span style=display:flex><span>Brief description of what this module creates.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Usage
</span></span></span><span style=display:flex><span>\`\`\`hcl
</span></span><span style=display:flex><span>module &#34;example&#34; {
</span></span><span style=display:flex><span>  source = &#34;./modules/example&#34;
</span></span><span style=display:flex><span>  name   = &#34;my-resource&#34;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>\`\`\`
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Requirements
</span></span></span><span style=display:flex><span>| Name | Version |
</span></span><span style=display:flex><span>|------|---------|
</span></span><span style=display:flex><span>| terraform | &gt;= 1.0 |
</span></span><span style=display:flex><span>| aws | &gt;= 5.0 |
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Inputs
</span></span></span><span style=display:flex><span>| Name | Description | Type | Default | Required |
</span></span><span style=display:flex><span>|------|-------------|------|---------|----------|
</span></span><span style=display:flex><span>| name | Resource name | string | n/a | yes |
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Outputs
</span></span></span><span style=display:flex><span>| Name | Description |
</span></span><span style=display:flex><span>|------|-------------|
</span></span><span style=display:flex><span>| id | Resource ID |
</span></span></code></pre></div><h3 id=auto-generated-docs>Auto-Generated Docs</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># terraform-docs</span>
</span></span><span style=display:flex><span>terraform-docs markdown table . &gt; README.md
</span></span></code></pre></div><hr><h2 id=workflow>Workflow</h2><h3 id=gitops-workflow>GitOps Workflow</h3><pre tabindex=0><code>┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Commit  │ ──▶ │    PR    │ ──▶ │  Review  │ ──▶ │  Merge   │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
                      │                                  │
                      ▼                                  ▼
                 ┌──────────┐                      ┌──────────┐
                 │  Plan    │                      │  Apply   │
                 │ (Preview)│                      │(Automated)│
                 └──────────┘                      └──────────┘
</code></pre><h3 id=change-management>Change Management</h3><ol><li><strong>Plan</strong>: Preview changes</li><li><strong>Review</strong>: Peer review the plan</li><li><strong>Approve</strong>: Explicit approval</li><li><strong>Apply</strong>: Automated application</li><li><strong>Verify</strong>: Confirm success</li></ol><hr><h2 id=quick-reference>Quick Reference</h2><pre tabindex=0><code>IaC Checklist:
□ All infrastructure in version control
□ Declarative configuration
□ Remote state with locking
□ State encryption enabled
□ Modular, reusable code
□ Environment separation
□ No secrets in code
□ Security scanning in CI
□ Policy enforcement
□ Documentation up to date
□ Tested before deployment
</code></pre></div></div><script src=/assets/shared-nav.js></script></body></html>