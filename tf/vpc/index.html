<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>VPC // rowstu.net</title><link rel=stylesheet href=/assets/shared-theme.css><style>.markdown-content{max-width:900px;margin:0 auto;line-height:1.7}.markdown-content h1{font-size:2.5rem;margin-bottom:1rem;color:var(--accent-teal);border-bottom:2px solid var(--border);padding-bottom:.5rem}.markdown-content h2{font-size:2rem;margin-top:2rem;margin-bottom:1rem;color:var(--accent-orange)}.markdown-content h3{font-size:1.5rem;margin-top:1.5rem;margin-bottom:.75rem;color:var(--text-primary)}.markdown-content p{margin-bottom:1rem}.markdown-content code{background:var(--bg-light);padding:.2rem .4rem;border-radius:3px;font-family:jetbrains mono,monospace;font-size:.9em}.markdown-content pre{background:var(--bg-light);padding:1rem;border-radius:6px;overflow-x:auto;margin-bottom:1rem}.markdown-content pre code{background:0 0;padding:0}.markdown-content a{color:var(--accent-teal);text-decoration:none}.markdown-content a:hover{text-decoration:underline}.markdown-content ul,.markdown-content ol{margin-bottom:1rem;padding-left:2rem}.markdown-content li{margin-bottom:.5rem}.markdown-content blockquote{border-left:4px solid var(--accent-teal);padding-left:1rem;margin:1rem 0;color:var(--text-secondary);font-style:italic}.markdown-content table{width:100%;border-collapse:collapse;margin-bottom:1rem}.markdown-content th,.markdown-content td{border:1px solid var(--border);padding:.75rem;text-align:left}.markdown-content th{background:var(--bg-light);font-weight:600}.breadcrumb{padding:1rem 0;color:var(--text-secondary);font-size:.95rem}.breadcrumb a{color:var(--accent-teal);text-decoration:none}.breadcrumb a:hover{text-decoration:underline}</style></head><body><div class=app-header><h1 class=app-title>VPC</h1></div><div class=container><div class=breadcrumb><a href=/>Home</a> / <a href=/browse/>Browse</a>/ <a href=/tfvpc/>Tfvpc</a></div><div class="card markdown-content"><h1 id=vpc-configuration>VPC Configuration</h1><p>Building Virtual Private Clouds with Terraform.</p><h2 id=basic-vpc>Basic VPC</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_vpc&#34; &#34;main&#34;</span> {
</span></span><span style=display:flex><span>  cidr_block           <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.0.0.0/16&#34;</span>
</span></span><span style=display:flex><span>  enable_dns_hostnames <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  enable_dns_support   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;main-vpc&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=complete-vpc-with-subnets>Complete VPC with Subnets</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>locals</span> {
</span></span><span style=display:flex><span>  azs <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;eu-west-2a&#34;, &#34;eu-west-2b&#34;, &#34;eu-west-2c&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_vpc&#34; &#34;main&#34;</span> {
</span></span><span style=display:flex><span>  cidr_block           <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.0.0.0/16&#34;</span>
</span></span><span style=display:flex><span>  enable_dns_hostnames <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  enable_dns_support   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;main-vpc&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Public Subnets
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_subnet&#34; &#34;public&#34;</span> {
</span></span><span style=display:flex><span>  count                   <span style=color:#f92672>=</span> <span style=color:#66d9ef>length</span>(<span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>)
</span></span><span style=display:flex><span>  vpc_id                  <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  cidr_block              <span style=color:#f92672>=</span> <span style=color:#66d9ef>cidrsubnet</span>(<span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>cidr_block</span>, <span style=color:#ae81ff>8</span>, <span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span>)
</span></span><span style=display:flex><span>  availability_zone       <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>[<span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span>]
</span></span><span style=display:flex><span>  map_public_ip_on_launch <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;public-${local.azs[count.index]}&#34;</span>
</span></span><span style=display:flex><span>    Tier <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;public&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Private Subnets
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_subnet&#34; &#34;private&#34;</span> {
</span></span><span style=display:flex><span>  count             <span style=color:#f92672>=</span> <span style=color:#66d9ef>length</span>(<span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>)
</span></span><span style=display:flex><span>  vpc_id            <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  cidr_block        <span style=color:#f92672>=</span> <span style=color:#66d9ef>cidrsubnet</span>(<span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>cidr_block</span>, <span style=color:#ae81ff>8</span>, <span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span> <span style=color:#960050;background-color:#1e0010>+</span> <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>  availability_zone <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>[<span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;private-${local.azs[count.index]}&#34;</span>
</span></span><span style=display:flex><span>    Tier <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;private&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Database Subnets
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_subnet&#34; &#34;database&#34;</span> {
</span></span><span style=display:flex><span>  count             <span style=color:#f92672>=</span> <span style=color:#66d9ef>length</span>(<span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>)
</span></span><span style=display:flex><span>  vpc_id            <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  cidr_block        <span style=color:#f92672>=</span> <span style=color:#66d9ef>cidrsubnet</span>(<span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>cidr_block</span>, <span style=color:#ae81ff>8</span>, <span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span> <span style=color:#960050;background-color:#1e0010>+</span> <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>  availability_zone <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>[<span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;database-${local.azs[count.index]}&#34;</span>
</span></span><span style=display:flex><span>    Tier <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;database&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=internet-gateway>Internet Gateway</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_internet_gateway&#34; &#34;main&#34;</span> {
</span></span><span style=display:flex><span>  vpc_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;main-igw&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=nat-gateway>NAT Gateway</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_eip&#34; &#34;nat&#34;</span> {
</span></span><span style=display:flex><span>  count  <span style=color:#f92672>=</span> <span style=color:#66d9ef>length</span>(<span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>)
</span></span><span style=display:flex><span>  domain <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vpc&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nat-eip-${local.azs[count.index]}&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_internet_gateway</span>.<span style=color:#66d9ef>main</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_nat_gateway&#34; &#34;main&#34;</span> {
</span></span><span style=display:flex><span>  count         <span style=color:#f92672>=</span> <span style=color:#66d9ef>length</span>(<span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>)
</span></span><span style=display:flex><span>  allocation_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_eip</span>.<span style=color:#66d9ef>nat</span>[<span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  subnet_id     <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_subnet</span>.<span style=color:#66d9ef>public</span>[<span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nat-${local.azs[count.index]}&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_internet_gateway</span>.<span style=color:#66d9ef>main</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=route-tables>Route Tables</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Public Route Table
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_route_table&#34; &#34;public&#34;</span> {
</span></span><span style=display:flex><span>  vpc_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>route</span> {
</span></span><span style=display:flex><span>    cidr_block <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>
</span></span><span style=display:flex><span>    gateway_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_internet_gateway</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;public-rt&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_route_table_association&#34; &#34;public&#34;</span> {
</span></span><span style=display:flex><span>  count          <span style=color:#f92672>=</span> <span style=color:#66d9ef>length</span>(<span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>)
</span></span><span style=display:flex><span>  subnet_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_subnet</span>.<span style=color:#66d9ef>public</span>[<span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  route_table_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_route_table</span>.<span style=color:#66d9ef>public</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Private Route Tables (one per AZ for NAT)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_route_table&#34; &#34;private&#34;</span> {
</span></span><span style=display:flex><span>  count  <span style=color:#f92672>=</span> <span style=color:#66d9ef>length</span>(<span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>)
</span></span><span style=display:flex><span>  vpc_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>route</span> {
</span></span><span style=display:flex><span>    cidr_block     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>
</span></span><span style=display:flex><span>    nat_gateway_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_nat_gateway</span>.<span style=color:#66d9ef>main</span>[<span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;private-rt-${local.azs[count.index]}&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_route_table_association&#34; &#34;private&#34;</span> {
</span></span><span style=display:flex><span>  count          <span style=color:#f92672>=</span> <span style=color:#66d9ef>length</span>(<span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>azs</span>)
</span></span><span style=display:flex><span>  subnet_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_subnet</span>.<span style=color:#66d9ef>private</span>[<span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  route_table_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_route_table</span>.<span style=color:#66d9ef>private</span>[<span style=color:#66d9ef>count</span>.<span style=color:#66d9ef>index</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=network-acls>Network ACLs</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_network_acl&#34; &#34;public&#34;</span> {
</span></span><span style=display:flex><span>  vpc_id     <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  subnet_ids <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_subnet</span>.<span style=color:#66d9ef>public</span>[<span style=color:#960050;background-color:#1e0010>*</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ingress</span> {
</span></span><span style=display:flex><span>    rule_no    <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    protocol   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>    action     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;allow&#34;</span>
</span></span><span style=display:flex><span>    cidr_block <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>
</span></span><span style=display:flex><span>    from_port  <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    to_port    <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ingress</span> {
</span></span><span style=display:flex><span>    rule_no    <span style=color:#f92672>=</span> <span style=color:#ae81ff>110</span>
</span></span><span style=display:flex><span>    protocol   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>    action     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;allow&#34;</span>
</span></span><span style=display:flex><span>    cidr_block <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>
</span></span><span style=display:flex><span>    from_port  <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>    to_port    <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ingress</span> {
</span></span><span style=display:flex><span>    rule_no    <span style=color:#f92672>=</span> <span style=color:#ae81ff>120</span>
</span></span><span style=display:flex><span>    protocol   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>    action     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;allow&#34;</span>
</span></span><span style=display:flex><span>    cidr_block <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>
</span></span><span style=display:flex><span>    from_port  <span style=color:#f92672>=</span> <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>    to_port    <span style=color:#f92672>=</span> <span style=color:#ae81ff>65535</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>egress</span> {
</span></span><span style=display:flex><span>    rule_no    <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    protocol   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;-1&#34;</span>
</span></span><span style=display:flex><span>    action     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;allow&#34;</span>
</span></span><span style=display:flex><span>    cidr_block <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>
</span></span><span style=display:flex><span>    from_port  <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    to_port    <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;public-nacl&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=vpc-flow-logs>VPC Flow Logs</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_flow_log&#34; &#34;main&#34;</span> {
</span></span><span style=display:flex><span>  vpc_id                   <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  traffic_type             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ALL&#34;</span>
</span></span><span style=display:flex><span>  log_destination_type     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cloud-watch-logs&#34;</span>
</span></span><span style=display:flex><span>  log_destination          <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_cloudwatch_log_group</span>.<span style=color:#66d9ef>flow_logs</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>  iam_role_arn             <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_iam_role</span>.<span style=color:#66d9ef>flow_logs</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>  max_aggregation_interval <span style=color:#f92672>=</span> <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vpc-flow-logs&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_cloudwatch_log_group&#34; &#34;flow_logs&#34;</span> {
</span></span><span style=display:flex><span>  name              <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/aws/vpc/flow-logs&#34;</span>
</span></span><span style=display:flex><span>  retention_in_days <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_role&#34; &#34;flow_logs&#34;</span> {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vpc-flow-logs-role&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  assume_role_policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>({
</span></span><span style=display:flex><span>    Version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2012-10-17&#34;</span>
</span></span><span style=display:flex><span>    Statement <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        Action <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sts:AssumeRole&#34;</span>
</span></span><span style=display:flex><span>        Effect <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>        Principal <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          Service <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vpc-flow-logs.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_role_policy&#34; &#34;flow_logs&#34;</span> {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vpc-flow-logs-policy&#34;</span>
</span></span><span style=display:flex><span>  role <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_iam_role</span>.<span style=color:#66d9ef>flow_logs</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>({
</span></span><span style=display:flex><span>    Version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2012-10-17&#34;</span>
</span></span><span style=display:flex><span>    Statement <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        Action <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;logs:CreateLogGroup&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;logs:CreateLogStream&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;logs:PutLogEvents&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;logs:DescribeLogGroups&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;logs:DescribeLogStreams&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        Effect   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>        Resource <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=vpc-endpoints>VPC Endpoints</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Gateway Endpoint for S3
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_vpc_endpoint&#34; &#34;s3&#34;</span> {
</span></span><span style=display:flex><span>  vpc_id            <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  service_name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.amazonaws.eu-west-2.s3&#34;</span>
</span></span><span style=display:flex><span>  vpc_endpoint_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Gateway&#34;</span>
</span></span><span style=display:flex><span>  route_table_ids   <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_route_table</span>.<span style=color:#66d9ef>private</span>[<span style=color:#960050;background-color:#1e0010>*</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;s3-endpoint&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Interface Endpoint for SSM
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_vpc_endpoint&#34; &#34;ssm&#34;</span> {
</span></span><span style=display:flex><span>  vpc_id              <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  service_name        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.amazonaws.eu-west-2.ssm&#34;</span>
</span></span><span style=display:flex><span>  vpc_endpoint_type   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Interface&#34;</span>
</span></span><span style=display:flex><span>  subnet_ids          <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_subnet</span>.<span style=color:#66d9ef>private</span>[<span style=color:#960050;background-color:#1e0010>*</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  security_group_ids  <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_security_group</span>.<span style=color:#66d9ef>vpc_endpoints</span>.<span style=color:#66d9ef>id</span>]
</span></span><span style=display:flex><span>  private_dns_enabled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ssm-endpoint&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_security_group&#34; &#34;vpc_endpoints&#34;</span> {
</span></span><span style=display:flex><span>  name        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vpc-endpoints-sg&#34;</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Security group for VPC endpoints&#34;</span>
</span></span><span style=display:flex><span>  vpc_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ingress</span> {
</span></span><span style=display:flex><span>    from_port   <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>    to_port     <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>    protocol    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>    cidr_blocks <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>cidr_block</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vpc-endpoints-sg&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=outputs>Outputs</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;vpc_id&#34;</span> {
</span></span><span style=display:flex><span>  value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;public_subnet_ids&#34;</span> {
</span></span><span style=display:flex><span>  value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_subnet</span>.<span style=color:#66d9ef>public</span>[<span style=color:#960050;background-color:#1e0010>*</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;private_subnet_ids&#34;</span> {
</span></span><span style=display:flex><span>  value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_subnet</span>.<span style=color:#66d9ef>private</span>[<span style=color:#960050;background-color:#1e0010>*</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;database_subnet_ids&#34;</span> {
</span></span><span style=display:flex><span>  value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_subnet</span>.<span style=color:#66d9ef>database</span>[<span style=color:#960050;background-color:#1e0010>*</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div><script src=/assets/shared-nav.js></script></body></html>