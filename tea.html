<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TEA.DEMO – AMIGA CRACKTRO</title>
  <script src="libopenmpt.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000022;
      color: #00ffcc;
      font-family: "Courier New", monospace;
      overflow: hidden;
    }

    canvas { display: block; position:absolute; top:0; left:0; z-index:1; }

    #topbar {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 32px;
      background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
      animation: hue 6s linear infinite;
      z-index: 2;
    }

    @keyframes hue {
      from { filter: hue-rotate(0deg); }
      to { filter: hue-rotate(360deg); }
    }

    #scroller {
      position: absolute;
      bottom: 16px;
      width: 100%;
      white-space: nowrap;
      font-size: 20px;
      color: #ffff00;
      text-shadow: 2px 2px #ff0000;
      overflow: hidden;
      z-index: 2;
      pointer-events: none;
    }

    #scroller span {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 25s linear infinite;
    }

    @keyframes scroll {
      from { transform: translateX(0); }
      to { transform: translateX(-100%); }
    }

    #hint {
      position: absolute;
      top: 40px;
      left: 20px;
      font-size: 14px;
      color: #ffffff;
      opacity: 0.8;
      z-index: 2;
    }
  </style>
</head>
<body>

  <div id="topbar"></div>
  <div id="hint">AUTOPLAY VISUALS — CLICK ANYWHERE TO ENABLE SOUND ☕</div>
  <canvas id="screen"></canvas>

  <div id="scroller">
    <span>
      *** DEDICATED TO ALL AMIGA PIRATES AT CHELL CRICKET CLUB *** PUT THE KETTLE ON! *** YORKSHIRE TEA, PG TIPS, TWININGS & TETLEY FOREVER *** MILK FIRST? WE DON'T CARE – JUST BREW IT *** GREETINGS TO THE DEMOSCENE *** KEEP THE AMIGA ALIVE! ***
    </span>
  </div>

<script>
const canvas = document.getElementById('screen');
const ctx = canvas.getContext('2d');

function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
window.addEventListener('resize', resize);
resize();

// PAL 50Hz timing
const PAL_FRAME_MS = 1000 / 50;
let lastFrame = performance.now();
let palAccum = 0;

let t = 0;
let phase = 1; // AUTO START NOW

// Tea sprite
function drawTeaBag(x,y,scale){
  ctx.fillStyle = '#c0a070';
  ctx.fillRect(x,y,2*scale,3*scale);
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(x+scale,y+3*scale,2*scale,1*scale);
  ctx.fillStyle = '#888888';
  ctx.fillRect(x+scale,y-2*scale,1*scale,2*scale);
}

// Font
const FONT = {
  'A':[0x18,0x24,0x42,0x7E,0x42,0x42,0x42,0x00],
  'B':[0x7C,0x42,0x42,0x7C,0x42,0x42,0x7C,0x00],
  'C':[0x3C,0x42,0x40,0x40,0x40,0x42,0x3C,0x00],
  'D':[0x78,0x44,0x42,0x42,0x42,0x44,0x78,0x00],
  'E':[0x7E,0x40,0x40,0x7C,0x40,0x40,0x7E,0x00],
  'F':[0x7E,0x40,0x40,0x7C,0x40,0x40,0x40,0x00],
  'G':[0x3C,0x42,0x40,0x4E,0x42,0x42,0x3C,0x00],
  'H':[0x42,0x42,0x42,0x7E,0x42,0x42,0x42,0x00],
  'I':[0x7E,0x18,0x18,0x18,0x18,0x18,0x7E,0x00],
  'J':[0x1E,0x04,0x04,0x04,0x04,0x44,0x38,0x00],
  'K':[0x42,0x44,0x48,0x70,0x48,0x44,0x42,0x00],
  'L':[0x40,0x40,0x40,0x40,0x40,0x40,0x7E,0x00],
  'M':[0x42,0x66,0x5A,0x5A,0x42,0x42,0x42,0x00],
  'N':[0x42,0x62,0x52,0x4A,0x46,0x42,0x42,0x00],
  'O':[0x3C,0x42,0x42,0x42,0x42,0x42,0x3C,0x00],
  'P':[0x7C,0x42,0x42,0x7C,0x40,0x40,0x40,0x00],
  'Q':[0x3C,0x42,0x42,0x42,0x4A,0x44,0x3A,0x00],
  'R':[0x7C,0x42,0x42,0x7C,0x48,0x44,0x42,0x00],
  'S':[0x3C,0x42,0x40,0x3C,0x02,0x42,0x3C,0x00],
  'T':[0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00],
  'U':[0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00],
  'V':[0x42,0x42,0x42,0x42,0x24,0x24,0x18,0x00],
  'W':[0x42,0x42,0x42,0x5A,0x5A,0x66,0x42,0x00],
  'X':[0x42,0x24,0x18,0x18,0x18,0x24,0x42,0x00],
  'Y':[0x42,0x24,0x24,0x18,0x18,0x18,0x18,0x00],
  'Z':[0x7E,0x02,0x04,0x18,0x20,0x40,0x7E,0x00],
  '0':[0x3C,0x42,0x46,0x4A,0x52,0x62,0x3C,0x00],
  '1':[0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00],
  '2':[0x3C,0x42,0x02,0x0C,0x30,0x40,0x7E,0x00],
  '3':[0x3C,0x42,0x02,0x1C,0x02,0x42,0x3C,0x00],
  '4':[0x04,0x0C,0x14,0x24,0x7E,0x04,0x04,0x00],
  '5':[0x7E,0x40,0x7C,0x02,0x02,0x42,0x3C,0x00],
  '6':[0x1C,0x20,0x40,0x7C,0x42,0x42,0x3C,0x00],
  '7':[0x7E,0x02,0x04,0x08,0x10,0x10,0x10,0x00],
  '8':[0x3C,0x42,0x42,0x3C,0x42,0x42,0x3C,0x00],
  '9':[0x3C,0x42,0x42,0x3E,0x02,0x04,0x38,0x00],
  ' ':[0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
  '*':[0x00,0x24,0x18,0x7E,0x18,0x24,0x00,0x00],
  '.':[0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00],
  ',':[0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x10],
  '!':[0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00],
  '?':[0x3C,0x42,0x02,0x0C,0x10,0x00,0x10,0x00],
  '-':[0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00]
};

function drawChar(ch, x, y, col){
  const glyph = FONT[ch] || FONT[' '];
  ctx.fillStyle = col;
  for(let row=0; row<8; row++){
    const bits = glyph[row];
    for(let bit=0; bit<8; bit++){
      if(bits & (1 << (7-bit))){
        ctx.fillRect(x + bit, y + row, 1, 1);
      }
    }
  }
}

function drawText8x8(text, x, y, col){
  text = text.toUpperCase();
  for(let i=0;i<text.length;i++){
    drawChar(text[i], x + i*9, y, col);
  }
}

// Starfield
const stars = Array.from({length:120}, () => ({x:Math.random(), y:Math.random(), z:Math.random()}));
function drawStarfield(w,h){
  ctx.fillStyle='#000022';
  ctx.fillRect(0,0,w,h);
  ctx.fillStyle='#ffffff';
  for(let s of stars){
    s.z -= 0.02;
    if(s.z <= 0){ s.z = 1; s.x = Math.random(); s.y = Math.random(); }
    const x = (s.x - 0.5) * (w / s.z) + w/2;
    const y = (s.y - 0.5) * (h / s.z) + h/2;
    if(x<0||x>w||y<0||y>h) continue;
    const size = (1 - s.z) * 3;
    ctx.fillRect(x, y, size, size);
  }
}

// Fractal + geometry
function drawFractal(w,h){
  const img = ctx.createImageData(w, h);
  const data = img.data;
  const scale = 1.5;
  const cx = -0.5 + 0.3*Math.sin(t*0.02);
  const cy = 0.0 + 0.3*Math.cos(t*0.02);
  for(let y=0;y<h;y+=2){
    for(let x=0;x<w;x+=2){
      let zx = (x/w - 0.5) * scale * (w/h);
      let zy = (y/h - 0.5) * scale;
      let i=0;
      while(i<40 && zx*zx+zy*zy<4){
        const xt = zx*zx - zy*zy + cx;
        zy = 2*zx*zy + cy;
        zx = xt;
        i++;
      }
      const col = i===40 ? 0 : (i*6)%255;
      const idx = (y*w + x)*4;
      data[idx]=col; data[idx+1]=255-col; data[idx+2]=col; data[idx+3]=255;
      data[idx+w*4]=col; data[idx+w*4+1]=255-col; data[idx+w*4+2]=col; data[idx+w*4+3]=255;
    }
  }
  ctx.putImageData(img,0,0);
}

function drawGeometry(w,h){
  ctx.fillStyle='#000022';
  ctx.fillRect(0,0,w,h);
  ctx.strokeStyle='#00ffcc';
  ctx.lineWidth=2;
  const cx=w/2, cy=h/2;
  const r= Math.min(w,h)/4;
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI*2);
  ctx.stroke();

  ctx.strokeStyle='#ffff00';
  ctx.beginPath();
  ctx.moveTo(cx, cy-r);
  for(let i=1;i<=6;i++){
    const a = i*Math.PI/3 + t*0.02;
    ctx.lineTo(cx + Math.cos(a)*r, cy + Math.sin(a)*r);
  }
  ctx.closePath();
  ctx.stroke();

  ctx.strokeStyle='#ff00ff';
  ctx.beginPath();
  for(let i=0;i<5;i++){
    const a = i*2*Math.PI/5 + t*0.03;
    const x = cx + Math.cos(a)*r*0.7;
    const y = cy + Math.sin(a)*r*0.7;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.closePath();
  ctx.stroke();
}

let mode = 0;
let modeTimer = 0;

function drawScene(){
  const w=canvas.width, h=canvas.height;

  modeTimer++;
  if(modeTimer > 250) { modeTimer = 0; mode = (mode+1)%2; }

  if(mode===0) drawStarfield(w,h);
  else {
    drawFractal(w,h);
    drawGeometry(w,h);
  }

  for(let i=0;i<10;i++){
    const x = (t*30 + i*60) % (w+80) - 80;
    const y = h/2 + 80 + Math.sin(t*1.2 + i) * 20;
    drawTeaBag(x,y,4);
  }

  drawText8x8('TEA.DEMO', w/2-90, h/2-70, '#ffff00');
  drawText8x8('DEDICATED TO ALL AMIGA PIRATES', w/2-220, h/2-30, '#00ffcc');
  drawText8x8('AT CHELL CRICKET CLUB', w/2-190, h/2-10, '#00ffcc');

  t += 0.03;
}

function frame(){
  const now = performance.now();
  palAccum += now - lastFrame;
  lastFrame = now;

  while(palAccum >= PAL_FRAME_MS){
    palAccum -= PAL_FRAME_MS;
    drawScene();
  }

  requestAnimationFrame(frame);
}

frame();

// ================= MOD PLAYBACK =================
let audioCtx, mod, node;
let modReady = false;

async function startMod(){
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const response = await fetch('DAXX - Children 165bpm.mod');
  const buffer = await response.arrayBuffer();

  await new Promise(resolve => libopenmpt.onRuntimeInitialized = resolve);
  mod = new libopenmpt.Module(buffer);

  node = audioCtx.createScriptProcessor(4096, 0, 2);
  node.onaudioprocess = e => {
    const left = e.outputBuffer.getChannelData(0);
    const right = e.outputBuffer.getChannelData(1);
    mod.readStereo(left, right, left.length);
  };
  node.connect(audioCtx.destination);

  modReady = true;
}

// Auto load MOD but audio will start only after gesture
startMod();

// enable sound on first click/tap
window.addEventListener('pointerdown', async () => {
  if(audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();
});
</script>
</body>
</html>
