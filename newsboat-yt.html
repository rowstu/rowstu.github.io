<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>YouTube → Newsboat // rowstu.net</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
	<style>
		:root {
			--bg: #1a1d23;
			--surface: #252932;
			--surface-hover: #2d323d;
			--border: #3d4351;
			--text: #e4e7eb;
			--text-muted: #9ca3af;
			--accent: #ef4444;
			--accent-dim: rgba(239, 68, 68, 0.15);
			--success: #10b981;
			--warning: #f59e0b;
			--info: #3b82f6;
		}

		* { margin: 0; padding: 0; box-sizing: border-box; }

		body {
			font-family: 'IBM Plex Mono', monospace;
			background: var(--bg);
			color: var(--text);
			min-height: 100vh;
			padding: 1.5rem;
		}

		.container { max-width: 800px; margin: 0 auto; }

		header { margin-bottom: 1.5rem; }

		h1 {
			font-size: 1.5rem;
			font-weight: 600;
			color: var(--accent);
			margin-bottom: 0.5rem;
		}

		h1 .pipe { color: var(--text-muted); }

		.subtitle { color: var(--text-muted); font-size: 0.875rem; }

		.input-row {
			display: flex;
			gap: 0.5rem;
			margin-bottom: 1rem;
		}

		input[type="text"] {
			flex: 1;
			padding: 0.65rem 1rem;
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 4px;
			color: var(--text);
			font-family: inherit;
			font-size: 0.85rem;
			outline: none;
			transition: border-color 0.2s;
		}

		input[type="text"]::placeholder { color: var(--text-muted); }
		input[type="text"]:focus { border-color: var(--accent); }

		button {
			padding: 0.65rem 1.25rem;
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 4px;
			color: var(--text);
			font-family: inherit;
			font-size: 0.8rem;
			cursor: pointer;
			transition: all 0.2s;
			white-space: nowrap;
		}

		button:hover {
			background: var(--surface-hover);
			border-color: var(--accent);
		}

		button.primary {
			background: var(--accent);
			border-color: var(--accent);
			color: #fff;
			font-weight: 500;
		}

		button.primary:hover { opacity: 0.9; }

		button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.examples {
			margin-bottom: 1.5rem;
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			align-items: center;
		}

		.examples-label {
			font-size: 0.75rem;
			color: var(--text-muted);
			margin-right: 0.25rem;
		}

		.example-btn {
			padding: 0.3rem 0.6rem;
			font-size: 0.7rem;
			background: var(--bg);
			border: 1px solid var(--border);
			border-radius: 3px;
			color: var(--text-muted);
			cursor: pointer;
			transition: all 0.2s;
		}

		.example-btn:hover {
			border-color: var(--accent);
			color: var(--text);
		}

		.panel {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 6px;
			margin-bottom: 1rem;
			overflow: hidden;
		}

		.panel-header {
			padding: 0.75rem 1rem;
			border-bottom: 1px solid var(--border);
			font-size: 0.8rem;
			color: var(--text-muted);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.panel-header .label { font-weight: 500; color: var(--text); }

		.panel-body { padding: 1rem; }

		.result-row {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			margin-bottom: 0.75rem;
		}

		.result-row:last-child { margin-bottom: 0; }

		.result-label {
			font-size: 0.75rem;
			color: var(--text-muted);
			min-width: 90px;
			text-transform: uppercase;
			letter-spacing: 0.05em;
		}

		.result-value {
			flex: 1;
			font-size: 0.85rem;
			color: var(--text);
			word-break: break-all;
		}

		.result-value.channel-name { color: var(--accent); font-weight: 500; }

		.result-value a {
			color: var(--info);
			text-decoration: none;
		}

		.result-value a:hover { text-decoration: underline; }

		.newsboat-url {
			width: 100%;
			padding: 0.75rem 1rem;
			background: var(--bg);
			border: 1px solid var(--border);
			border-radius: 4px;
			color: var(--success);
			font-family: inherit;
			font-size: 0.85rem;
			outline: none;
			cursor: text;
			margin-top: 0.5rem;
		}

		.newsboat-config {
			width: 100%;
			padding: 0.75rem 1rem;
			background: var(--bg);
			border: 1px solid var(--border);
			border-radius: 4px;
			color: var(--warning);
			font-family: inherit;
			font-size: 0.8rem;
			outline: none;
			cursor: text;
			margin-top: 0.5rem;
			line-height: 1.5;
		}

		.copy-row {
			display: flex;
			gap: 0.5rem;
			margin-top: 0.75rem;
		}

		.status {
			padding: 0.75rem 1rem;
			border-radius: 4px;
			font-size: 0.8rem;
			margin-bottom: 1rem;
			display: none;
		}

		.status.visible { display: block; }

		.status.error {
			background: rgba(239, 68, 68, 0.1);
			border: 1px solid rgba(239, 68, 68, 0.3);
			color: #fca5a5;
		}

		.status.loading {
			background: rgba(59, 130, 246, 0.1);
			border: 1px solid rgba(59, 130, 246, 0.3);
			color: #93c5fd;
		}

		.spinner {
			display: inline-block;
			width: 12px;
			height: 12px;
			border: 2px solid rgba(147, 197, 253, 0.3);
			border-top-color: #93c5fd;
			border-radius: 50%;
			animation: spin 0.6s linear infinite;
			margin-right: 0.5rem;
			vertical-align: middle;
		}

		@keyframes spin { to { transform: rotate(360deg); } }

		#resultPanel { display: none; }
		#resultPanel.visible { display: block; }

		.info-panel {
			background: var(--bg);
			border: 1px solid var(--border);
			border-radius: 6px;
			padding: 1rem;
			margin-top: 1.5rem;
		}

		.info-panel h3 {
			font-size: 0.8rem;
			color: var(--warning);
			margin-bottom: 0.5rem;
			text-transform: uppercase;
			letter-spacing: 0.05em;
		}

		.info-panel p, .info-panel code {
			font-size: 0.8rem;
			color: var(--text-muted);
			line-height: 1.6;
		}

		.info-panel code {
			background: var(--surface);
			padding: 0.15rem 0.4rem;
			border-radius: 3px;
			color: var(--success);
		}

		.info-panel pre {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 4px;
			padding: 0.75rem;
			margin-top: 0.5rem;
			overflow-x: auto;
			font-size: 0.78rem;
			line-height: 1.5;
			color: var(--text-muted);
		}

		.info-panel pre span.hl { color: var(--success); }

		.toast {
			position: fixed;
			bottom: 2rem;
			left: 50%;
			transform: translateX(-50%) translateY(100%);
			background: var(--surface);
			border: 1px solid var(--accent);
			color: var(--text);
			padding: 0.5rem 1.25rem;
			border-radius: 4px;
			font-size: 0.8rem;
			font-family: inherit;
			opacity: 0;
			transition: all 0.3s ease;
			z-index: 100;
		}

		.toast.show {
			transform: translateX(-50%) translateY(0);
			opacity: 1;
		}

		.back-link {
			display: inline-block;
			margin-top: 1rem;
			color: var(--text-muted);
			text-decoration: none;
			font-size: 0.875rem;
		}

		.back-link:hover { color: var(--accent); }

		@media (max-width: 600px) {
			.input-row { flex-direction: column; }
			.result-row { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
			.result-label { min-width: auto; }
			.copy-row { flex-direction: column; }
		}
	</style>
</head>
<body>
	<div class="container">
		<header>
			<h1>YouTube <span class="pipe">→</span> Newsboat</h1>
			<p class="subtitle">Get a Newsboat RSS feed URL from any YouTube video, channel, or @handle</p>
		</header>

		<div class="input-row">
			<input type="text" id="ytInput" placeholder="Paste a YouTube URL or type @handle..." autofocus>
			<button class="primary" id="resolveBtn" onclick="resolve()">Resolve</button>
		</div>

		<div class="examples">
			<span class="examples-label">Try:</span>
			<button class="example-btn" onclick="tryExample('@3blue1brown')">@3blue1brown</button>
			<button class="example-btn" onclick="tryExample('https://www.youtube.com/watch?v=dQw4w9WgXcQ')">Video URL</button>
			<button class="example-btn" onclick="tryExample('https://www.youtube.com/channel/UCYO_jab_esuFRV4b17AJtAw')">Channel URL</button>
			<button class="example-btn" onclick="tryExample('https://www.youtube.com/@NetworkChuck')">@NetworkChuck</button>
		</div>

		<div class="status" id="status"></div>

		<div class="panel" id="resultPanel">
			<div class="panel-header">
				<span class="label">Result</span>
				<button onclick="clearAll()" style="padding: 0.3rem 0.6rem; font-size: 0.7rem;">Clear</button>
			</div>
			<div class="panel-body">
				<div class="result-row">
					<span class="result-label">Channel</span>
					<span class="result-value channel-name" id="channelName">—</span>
				</div>
				<div class="result-row">
					<span class="result-label">Channel ID</span>
					<span class="result-value" id="channelId">—</span>
				</div>

				<input type="text" class="newsboat-url" id="feedUrl" readonly>

				<input type="text" class="newsboat-config" id="newsboatLine" readonly>

				<div class="copy-row">
					<button onclick="copyField('feedUrl')">Copy Feed URL</button>
					<button onclick="copyField('newsboatLine')">Copy Newsboat Line</button>
				</div>
			</div>
		</div>

		<div class="info-panel">
			<h3>Usage</h3>
			<p>Paste a YouTube URL or <code>@handle</code> and this tool resolves the channel ID, then builds the RSS feed URL for <a href="https://newsboat.org" target="_blank" style="color: var(--info);">Newsboat</a>.</p>
			<p style="margin-top: 0.5rem;">Add the generated line to your <code>~/.newsboat/urls</code> file:</p>
			<pre><span class="hl">https://www.youtube.com/feeds/videos.xml?channel_id=UCxxxx</span> "~Channel Name" "youtube"</pre>
		</div>

		<a href="/" class="back-link">&larr; Back to home</a>
	</div>

	<div class="toast" id="toast"></div>

	<script>
		// --- Strategy ---
		// 1. CORS proxies to scrape YouTube pages directly (most reliable)
		// 2. Piped/Invidious APIs as parallel fallbacks
		// All raced with Promise.any — first success wins.

		const CORS_PROXIES = [
			url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
			url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
		];

		const PIPED_INSTANCES = [
			'https://pipedapi.kavin.rocks',
			'https://pipedapi.r4fo.com',
			'https://pipedapi.adminforge.de'
		];

		const INVIDIOUS_INSTANCES = [
			'https://inv.tux.pizza',
			'https://invidious.fdn.fr',
			'https://vid.puffyan.us'
		];

		const ytInput = document.getElementById('ytInput');
		const resolveBtn = document.getElementById('resolveBtn');
		const statusEl = document.getElementById('status');
		const resultPanel = document.getElementById('resultPanel');

		ytInput.addEventListener('keydown', e => {
			if (e.key === 'Enter') resolve();
		});

		function tryExample(val) {
			ytInput.value = val;
			resolve();
		}

		function showStatus(msg, type) {
			statusEl.className = 'status visible ' + type;
			statusEl.innerHTML = type === 'loading'
				? '<span class="spinner"></span>' + msg
				: msg;
		}

		function hideStatus() {
			statusEl.className = 'status';
		}

		function showToast(msg) {
			const toast = document.getElementById('toast');
			toast.textContent = msg;
			toast.classList.add('show');
			setTimeout(() => toast.classList.remove('show'), 1500);
		}

		function parseInput(raw) {
			const s = raw.trim();
			if (!s) return null;

			// Direct channel ID URL: /channel/UCxxxx
			const channelMatch = s.match(/youtube\.com\/channel\/(UC[\w-]{22,})/);
			if (channelMatch) return { type: 'channel_id', value: channelMatch[1] };

			// Video URL: watch?v= or youtu.be/
			const watchMatch = s.match(/[?&]v=([\w-]{11})/);
			if (watchMatch) return { type: 'video', value: watchMatch[1] };

			const shortMatch = s.match(/youtu\.be\/([\w-]{11})/);
			if (shortMatch) return { type: 'video', value: shortMatch[1] };

			// @handle in URL or plain text
			const handleMatch = s.match(/@([\w.-]+)/);
			if (handleMatch) return { type: 'handle', value: handleMatch[1] };

			// /c/CustomName or /user/Username
			const customMatch = s.match(/youtube\.com\/(?:c|user)\/([\w.-]+)/);
			if (customMatch) return { type: 'handle', value: customMatch[1] };

			return null;
		}

		// Fetch with abort timeout
		async function fetchWithTimeout(url, ms = 10000) {
			const controller = new AbortController();
			const timer = setTimeout(() => controller.abort(), ms);
			try {
				const res = await fetch(url, { signal: controller.signal });
				clearTimeout(timer);
				if (!res.ok) throw new Error(`HTTP ${res.status}`);
				return res;
			} catch (e) {
				clearTimeout(timer);
				throw e;
			}
		}

		// Extract channel ID and name from raw YouTube page HTML
		function extractFromHTML(html) {
			// channelId appears in ytInitialData / ytInitialPlayerResponse JSON
			const idMatch = html.match(/"channelId"\s*:\s*"(UC[\w-]+)"/);
			if (!idMatch) return null;

			const channelId = idMatch[1];

			// Try several patterns for the channel name
			let name = channelId;
			const namePatterns = [
				/"ownerChannelName"\s*:\s*"([^"]+)"/,
				/"author"\s*:\s*"([^"]+)"/,
				/"channelName"\s*:\s*"([^"]+)"/,
				/<link itemprop="name" content="([^"]+)">/,
				/<meta property="og:title" content="([^"]+)">/
			];
			for (const pat of namePatterns) {
				const m = html.match(pat);
				if (m) { name = m[1]; break; }
			}

			return { id: channelId, name };
		}

		// Build all resolver promises — CORS proxies + Piped + Invidious
		function buildResolvers(type, value) {
			const promises = [];

			// --- CORS proxy: scrape YouTube page directly ---
			let ytUrl;
			if (type === 'video') {
				ytUrl = `https://www.youtube.com/watch?v=${value}`;
			} else if (type === 'handle') {
				ytUrl = `https://www.youtube.com/@${value}`;
			} else if (type === 'channel_id') {
				ytUrl = `https://www.youtube.com/channel/${value}`;
			}

			if (ytUrl) {
				for (const makeUrl of CORS_PROXIES) {
					promises.push(
						fetchWithTimeout(makeUrl(ytUrl)).then(res => res.text()).then(html => {
							const result = extractFromHTML(html);
							if (!result) throw new Error('channel ID not found in page');
							return result;
						})
					);
				}
			}

			// --- Piped API ---
			for (const base of PIPED_INSTANCES) {
				if (type === 'video') {
					promises.push(
						fetchWithTimeout(`${base}/streams/${value}`).then(r => r.json()).then(data => {
							const m = (data.uploaderUrl || '').match(/\/channel\/(UC[\w-]+)/);
							if (!m) throw new Error('no channel id');
							return { id: m[1], name: data.uploader || 'Unknown' };
						})
					);
				} else if (type === 'handle') {
					promises.push(
						fetchWithTimeout(`${base}/channel/@${value}`).then(r => r.json()).then(data => {
							if (!data.id || !data.id.startsWith('UC')) throw new Error('no id');
							return { id: data.id, name: data.name || value };
						})
					);
				} else if (type === 'channel_id') {
					promises.push(
						fetchWithTimeout(`${base}/channel/${value}`).then(r => r.json()).then(data => {
							return { id: value, name: data.name || value };
						})
					);
				}
			}

			// --- Invidious API ---
			for (const base of INVIDIOUS_INSTANCES) {
				if (type === 'video') {
					promises.push(
						fetchWithTimeout(`${base}/api/v1/videos/${value}?fields=authorId,author`).then(r => r.json()).then(data => {
							if (!data.authorId) throw new Error('no authorId');
							return { id: data.authorId, name: data.author || 'Unknown' };
						})
					);
				} else if (type === 'handle') {
					promises.push(
						fetchWithTimeout(`${base}/api/v1/channels/@${value}?fields=authorId,author`).then(r => r.json()).then(data => {
							if (!data.authorId) throw new Error('no authorId');
							return { id: data.authorId, name: data.author || value };
						})
					);
				} else if (type === 'channel_id') {
					promises.push(
						fetchWithTimeout(`${base}/api/v1/channels/${value}?fields=authorId,author`).then(r => r.json()).then(data => {
							return { id: value, name: data.author || value };
						})
					);
				}
			}

			return promises;
		}

		async function resolve() {
			const raw = ytInput.value;
			const parsed = parseInput(raw);

			if (!parsed) {
				showStatus('Enter a YouTube video URL, channel URL, or @handle', 'error');
				return;
			}

			resultPanel.classList.remove('visible');
			resolveBtn.disabled = true;

			if (parsed.type === 'channel_id') {
				// We already have the ID — try to look up the name but don't block on it
				showStatus('Resolving channel name...', 'loading');
				const promises = buildResolvers('channel_id', parsed.value);
				let name = parsed.value;
				try {
					const result = await Promise.any(promises);
					name = result.name;
				} catch (e) { /* use ID as name fallback */ }
				hideStatus();
				showResult(parsed.value, name);
				resolveBtn.disabled = false;
				return;
			}

			const label = parsed.type === 'video' ? 'video' : '@' + parsed.value;
			showStatus(`Resolving channel from ${label}...`, 'loading');

			const promises = buildResolvers(parsed.type, parsed.value);

			try {
				const result = await Promise.any(promises);
				hideStatus();
				showResult(result.id, result.name);
			} catch (e) {
				showStatus(
					`Could not resolve channel. You can find the channel ID manually: visit the YouTube page, view page source, and search for <code>"channelId"</code>.`,
					'error'
				);
			}

			resolveBtn.disabled = false;
		}

		function showResult(channelId, channelName) {
			document.getElementById('channelName').textContent = channelName;
			document.getElementById('channelId').textContent = channelId;

			const feedUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${channelId}`;
			document.getElementById('feedUrl').value = feedUrl;

			const safeName = channelName.replace(/"/g, '\\"');
			document.getElementById('newsboatLine').value = `${feedUrl} "~${safeName}" "youtube"`;

			resultPanel.classList.add('visible');
		}

		function copyField(id) {
			const el = document.getElementById(id);
			navigator.clipboard.writeText(el.value).then(() => {
				showToast('Copied!');
			});
		}

		function clearAll() {
			ytInput.value = '';
			hideStatus();
			resultPanel.classList.remove('visible');
			ytInput.focus();
		}
	</script>
	<script src="/assets/shared-nav.js"></script>
</body>
</html>
